language: go
go:
  - 1.x

sudo: required
services:
  - docker

env:
  - GOVERSION=1.9
  - GOVERSION=1.10

matrix:
  include:
    # build a library for iOS
    - os: osx # gomobile: target=ios requires the host machine to be running OS X.
      go: 1.9
      install:
        # setup the cocoapods master repo
        - gem uninstall cocoapods -a -x
        - gem install cocoapods
        - pod setup --verbose
      script:
        - gomobile bind -target ios -v github.com/decred/dcrd/mobile
      before_deploy:
        # render cocoapods spec based on a template (project root directory)
        -
        # ensure that we have a valid cocoapod spec
        - pod spec lint template.podspec 
      deploy:
        - pod trunk push DCRD.podspec --allow-warnings --verbose
    
    # build a library for Android
    - os:
      language: android
      before_script:
        # verify that the sdk and ndk are available
        - 
      script:
        # install android compiler toolchain & generate android artifact
        - gomobile init -ndk $ANDROID_NDK 
        - gomobile -target android -javapkg org.decred -v github.com/decred/dcrd/mobile
      before_deploy:
        # import key
        - gpg --import $PGP_KEY
      deploy:
        # signs artifact and installs the artifact in the remote repository.
        - mvn gpg:sign-and-deploy-file -settings=mobile/build/mvn.settings -Durl="https://oss.sonatype.org/service/local/staging/deploy/maven2" -DrepositoryId=sonatype -pomFile=mobile/build/pom.xml -Dfile=dcrd.aar

install: true

script:
  - ./run_tests.sh $GOVERSION
